<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Responses - Blood Donation System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body class="bg-gray-100">
    <div class="min-h-screen flex">
      <!-- Sidebar -->
      <div class="bg-red-700 text-white w-64 py-6 px-4 flex flex-col">
        <div class="flex items-center mb-8">
          <i class="fas fa-droplet text-2xl mr-2"></i>
          <h1 class="text-xl font-bold">Donor Dashboard</h1>
        </div>

        <!-- Role Switcher -->
        <div class="mb-6 p-3 bg-red-600 rounded-lg">
          <div class="flex items-center justify-between mb-2">
            <p class="text-sm">
              Current Role:
              <span
                class="font-semibold text-white bg-red-700 px-2 py-1 rounded"
                >ðŸ©¸ Donor</span
              >
            </p>
            <div class="text-xs text-red-100">
              <i class="fas fa-user-check"></i>
            </div>
          </div>
          <form method="POST" action="/switch-role" class="inline w-full">
            <input type="hidden" name="role" value="receiver" />
            <button
              type="submit"
              class="w-full text-xs bg-white text-red-700 px-3 py-2 rounded hover:bg-gray-100 transition-colors font-medium"
              title="Switch to recipient mode to request blood when needed"
            >
              <i class="fas fa-exchange-alt mr-1"></i> Switch to Recipient Mode
            </button>
          </form>
          <p class="text-xs text-red-100 mt-1 text-center">
            Help others by donating blood
          </p>
        </div>

        <nav class="flex-1">
          <a
            href="/donor-dashboard#dashboard-section"
            class="flex items-center space-x-3 p-3 rounded hover:bg-red-600 transition-colors"
          >
            <i class="fas fa-home w-6"></i>
            <span>Dashboard</span>
          </a>
          <a
            href="/donor-dashboard#donations-section"
            class="flex items-center space-x-3 p-3 rounded hover:bg-red-600 transition-colors"
          >
            <i class="fas fa-history w-6"></i>
            <span>Donation History</span>
          </a>
          <a
            href="/donor-dashboard#requests-section"
            class="flex items-center space-x-3 p-3 rounded hover:bg-red-600 transition-colors"
          >
            <i class="fas fa-hand-holding-heart w-6"></i>
            <span>Blood Requests</span>
          </a>

          <a
            href="/donor-dashboard#upcoming-section"
            class="flex items-center space-x-3 p-3 rounded hover:bg-red-600 transition-colors"
          >
            <i class="fas fa-calendar-check w-6"></i>
            <span>Upcoming Donations</span>
            {% set accepted_count = donor_responses|selectattr("status",
            "equalto", "Accepted")|list|length %} {% if accepted_count > 0 %}
            <span
              class="bg-yellow-400 text-red-800 text-xs px-2 py-1 rounded-full font-bold ml-1"
              >{{ accepted_count }}</span
            >
            {% endif %}
          </a>
          <a
            href="/my-responses"
            class="flex items-center space-x-3 p-3 rounded bg-red-600 transition-colors"
          >
            <i class="fas fa-reply-all w-6"></i>
            <span>My Responses</span>
          </a>
          <a
            href="/donor-dashboard#profile-section"
            class="flex items-center space-x-3 p-3 rounded hover:bg-red-600 transition-colors"
          >
            <i class="fas fa-user w-6"></i>
            <span>My Profile</span>
          </a>
        </nav>

        <div class="mt-auto">
          <a
            href="/logout"
            class="flex items-center space-x-3 p-3 rounded hover:bg-red-600 transition-colors text-red-200"
          >
            <i class="fas fa-sign-out-alt w-6"></i>
            <span>Logout</span>
          </a>
        </div>
      </div>

      <!-- Main Content -->
      <div class="flex-1 p-8">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center">
            <a
              href="/donor-dashboard"
              class="text-gray-600 hover:text-gray-800 mr-4"
            >
              <i class="fas fa-arrow-left text-xl"></i>
            </a>
            <h1 class="text-2xl font-bold text-gray-800" id="page-title">
              My Donation Responses
            </h1>
          </div>
          <div class="flex items-center gap-4">
            <div class="text-sm text-gray-500">
              Total Responses: {{ responses|length }}
            </div>
            {% if responses %}
            <button
              onclick="clearAllResponses()"
              class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm font-medium"
            >
              <i class="fas fa-trash-alt mr-2"></i>Clear All
            </button>
            {% endif %}
          </div>
        </div>

        {% if responses %}
        <!-- Filter Tabs -->
        <div class="bg-white rounded-lg shadow mb-6">
          <div class="flex border-b border-gray-200" id="response-tabs">
            <button
              class="px-6 py-3 font-medium text-sm text-blue-600 border-b-2 border-blue-600 tab-button"
              onclick="filterResponses('all')"
              data-tab="all"
            >
              All ({{ responses|length }})
            </button>
            <button
              class="px-6 py-3 font-medium text-sm text-gray-500 hover:text-gray-700 tab-button"
              onclick="filterResponses('accepted')"
              data-tab="accepted"
            >
              Accepted ({{ responses|selectattr('status', 'equalto',
              'Accepted')|list|length }})
            </button>
            <button
              class="px-6 py-3 font-medium text-sm text-gray-500 hover:text-gray-700 tab-button"
              onclick="filterResponses('confirmed')"
              data-tab="confirmed"
            >
              Confirmed ({{ responses|selectattr('status', 'equalto',
              'Confirmed')|list|length }})
            </button>
            <button
              class="px-6 py-3 font-medium text-sm text-gray-500 hover:text-gray-700 tab-button"
              onclick="filterResponses('completed')"
              data-tab="completed"
            >
              Completed ({{ responses|selectattr('status', 'equalto',
              'Completed')|list|length }})
            </button>
          </div>
        </div>

        <!-- Responses List -->
        <div class="space-y-4">
          {% for response in responses %}
          <div
            class="bg-white rounded-lg shadow-lg p-6 response-item"
            data-status="{{ response.status|lower }}"
          >
            <!-- Response Header -->
            <div class="flex justify-between items-start mb-4">
              <div class="flex-1">
                <div class="flex items-center gap-3 mb-2">
                  <div
                    class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center"
                  >
                    <i class="fas fa-droplet text-red-600 text-lg"></i>
                  </div>
                  <div>
                    <h3 class="text-lg font-semibold text-gray-800">
                      {{ response.blood_request.blood_group_needed }} Blood
                      Request
                    </h3>
                    <p class="text-sm text-gray-600">
                      {{ response.blood_request.hospital_name }} â€¢ {{
                      response.blood_request.quantity_needed }}
                    </p>
                  </div>
                </div>
              </div>

              <div class="text-right ml-4">
                <span
                  class="px-3 py-1 text-sm font-semibold rounded-full {% if response.status == 'Accepted' %}text-green-800 bg-green-100 {% elif response.status == 'Rejected' %}text-red-800 bg-red-100 {% elif response.status == 'Confirmed' %}text-blue-800 bg-blue-100 {% elif response.status == 'Completed' %}text-purple-800 bg-purple-100 {% elif response.status == 'Declined' %}text-gray-800 bg-gray-100 {% elif response.status == 'Cancelled' %}text-red-800 bg-red-100 {% else %}text-yellow-800 bg-yellow-100{% endif %}"
                >
                  {{ response.status }}
                </span>
                <p class="text-xs text-gray-500 mt-1">
                  {{ response.response_date.strftime('%m/%d/%Y at %I:%M %p') }}
                </p>
              </div>
            </div>

            <!-- Request Details -->
            <div
              class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-4 bg-gray-50 rounded-lg"
            >
              <div>
                <p class="text-xs text-gray-600 font-medium">URGENCY</p>
                <p
                  class="text-sm font-semibold {% if response.blood_request.urgency == 'Critical' %}text-red-600 {% elif response.blood_request.urgency == 'High' %}text-orange-600 {% else %}text-blue-600{% endif %}"
                >
                  {{ response.blood_request.urgency }}
                </p>
              </div>
              <div>
                <p class="text-xs text-gray-600 font-medium">NEEDED BY</p>
                <p class="text-sm">
                  {{ response.blood_request.needed_by_date.strftime('%B %d, %Y')
                  }}
                </p>
              </div>
              <div>
                <p class="text-xs text-gray-600 font-medium">CONTACT</p>
                <p class="text-sm">
                  {{ response.blood_request.contact_person }}
                </p>
              </div>
            </div>

            <!-- Messages -->
            <div class="space-y-3">
              {% if response.donor_notes %}
              <div class="p-3 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                <p class="text-xs text-blue-600 font-medium mb-1">
                  <i class="fas fa-comment mr-1"></i>Your Message:
                </p>
                <p class="text-sm text-blue-800">{{ response.donor_notes }}</p>
              </div>
              {% endif %} {% if response.receiver_notes %}
              <div
                class="p-3 bg-green-50 rounded-lg border-l-4 border-green-400"
              >
                <p class="text-xs text-green-600 font-medium mb-1">
                  <i class="fas fa-reply mr-1"></i>Recipient's Response:
                </p>
                <p class="text-sm text-green-800">
                  {{ response.receiver_notes }}
                </p>
              </div>
              {% endif %}
            </div>

            <!-- Action Buttons -->
            <div
              class="flex justify-between items-center mt-4 pt-4 border-t border-gray-200"
            >
              <div class="text-sm text-gray-500">
                Request ID: #{{ response.blood_request.id }}
              </div>

              <div class="flex gap-2">
                {% if response.status == 'Confirmed' %}
                <form
                  method="POST"
                  action="/update-response/{{ response.id }}"
                  class="inline"
                >
                  <input type="hidden" name="status" value="Completed" />
                  <button
                    type="submit"
                    class="px-4 py-2 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition-colors"
                  >
                    <i class="fas fa-check mr-1"></i>Mark as Completed
                  </button>
                </form>
                {% endif %} {% if response.status in ['Accepted', 'Rejected'] %}
                <form
                  method="POST"
                  action="/update-response/{{ response.id }}"
                  class="inline"
                >
                  <input type="hidden" name="status" value="Cancelled" />
                  <button
                    type="submit"
                    class="px-4 py-2 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition-colors"
                  >
                    <i class="fas fa-times mr-1"></i>Cancel
                  </button>
                </form>
                {% endif %}

                <button
                  onclick="toggleDetails({{ response.id }})"
                  class="px-4 py-2 bg-gray-600 text-white text-sm rounded hover:bg-gray-700 transition-colors"
                >
                  <i class="fas fa-info-circle mr-1"></i>Details
                </button>
              </div>
            </div>

            <!-- Expandable Details -->
            <div
              id="details-{{ response.id }}"
              class="hidden mt-4 pt-4 border-t border-gray-200"
            >
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                  <h4 class="font-medium text-gray-800 mb-2">
                    Hospital Details
                  </h4>
                  <p>
                    <strong>Name:</strong> {{
                    response.blood_request.hospital_name }}
                  </p>
                  <p>
                    <strong>Location:</strong> {{
                    response.blood_request.hospital_location }}
                  </p>
                  <p>
                    <strong>Contact:</strong> {{
                    response.blood_request.contact_number }}
                  </p>
                </div>
                <div>
                  <h4 class="font-medium text-gray-800 mb-2">
                    Request Timeline
                  </h4>
                  <p>
                    <strong>Created:</strong> {{
                    response.blood_request.request_date.strftime('%m/%d/%Y at
                    %I:%M %p') }}
                  </p>
                  <p>
                    <strong>Your Response:</strong> {{
                    response.response_date.strftime('%m/%d/%Y at %I:%M %p') }}
                  </p>
                  <p>
                    <strong>Status:</strong> {{ response.blood_request.status }}
                  </p>
                </div>
              </div>

              {% if response.blood_request.additional_notes %}
              <div class="mt-4">
                <h4 class="font-medium text-gray-800 mb-2">
                  Additional Request Notes
                </h4>
                <div class="p-3 bg-gray-50 rounded">
                  <p class="text-sm text-gray-700">
                    {{ response.blood_request.additional_notes }}
                  </p>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>

        {% else %}
        <!-- Empty State -->
        <div class="bg-white rounded-lg shadow-lg p-12 text-center">
          <i class="fas fa-hand-holding-heart text-6xl text-gray-300 mb-4"></i>
          <h2 class="text-xl font-semibold text-gray-600 mb-2">
            No Responses Yet
          </h2>
          <p class="text-gray-500 mb-6">
            You haven't responded to any blood requests yet. Check the Blood
            Requests section in your dashboard to help those in need.
          </p>
          <a
            href="/donor-dashboard#requests-section"
            class="inline-block bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors"
          >
            <i class="fas fa-search mr-2"></i>View Blood Requests
          </a>
        </div>
        {% endif %}
      </div>
    </div>

    <script>
      function filterResponses(status) {
        const items = document.querySelectorAll(".response-item");
        const tabs = document.querySelectorAll(".tab-button");

        // Update tab styling
        tabs.forEach((tab) => {
          tab.classList.remove(
            "text-blue-600",
            "border-b-2",
            "border-blue-600"
          );
          tab.classList.add("text-gray-500");
        });

        const activeTab = document.querySelector(`[data-tab="${status}"]`);
        activeTab.classList.remove("text-gray-500");
        activeTab.classList.add(
          "text-blue-600",
          "border-b-2",
          "border-blue-600"
        );

        // Filter items
        items.forEach((item) => {
          if (status === "all" || item.dataset.status === status) {
            item.style.display = "block";
          } else {
            item.style.display = "none";
          }
        });
      }

      function toggleDetails(responseId) {
        const details = document.getElementById(`details-${responseId}`);
        details.classList.toggle("hidden");
      }

      function clearAllResponses() {
        if (
          !confirm(
            "Are you sure you want to clear all your donation responses? This action cannot be undone."
          )
        ) {
          return;
        }

        // Show loading state
        const clearBtn = event.target;
        const originalText = clearBtn.innerHTML;
        clearBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin mr-2"></i>Clearing...';
        clearBtn.disabled = true;

        // Send AJAX request
        fetch("/clear-all-responses", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest",
          },
          body: JSON.stringify({ action: "clear_all" }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // Animate out all response cards
              const responseItems = document.querySelectorAll(".response-item");
              responseItems.forEach((item, index) => {
                setTimeout(() => {
                  item.style.transition = "all 0.3s ease";
                  item.style.transform = "translateX(-100%)";
                  item.style.opacity = "0";
                }, index * 100);
              });

              // After animation, show empty state
              setTimeout(() => {
                window.location.reload();
              }, responseItems.length * 100 + 500);

              // Show success notification
              showNotification(
                "All responses cleared successfully!",
                "success"
              );
            } else {
              showNotification("Failed to clear responses", "error");
              // Restore button
              clearBtn.innerHTML = originalText;
              clearBtn.disabled = false;
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            showNotification(
              "An error occurred while clearing responses",
              "error"
            );
            // Restore button
            clearBtn.innerHTML = originalText;
            clearBtn.disabled = false;
          });
      }

      // Function to show notifications
      function showNotification(message, type = "info") {
        const notification = document.createElement("div");
        notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg text-white font-medium transition-all duration-300 transform translate-x-full ${
          type === "success"
            ? "bg-green-600"
            : type === "error"
            ? "bg-red-600"
            : "bg-blue-600"
        }`;
        notification.innerHTML = `
          <div class="flex items-center">
            <i class="fas fa-${
              type === "success"
                ? "check-circle"
                : type === "error"
                ? "exclamation-circle"
                : "info-circle"
            } mr-2"></i>
            ${message}
          </div>
        `;

        document.body.appendChild(notification);

        // Animate in
        setTimeout(() => {
          notification.style.transform = "translateX(0)";
        }, 100);

        // Remove after 3 seconds
        setTimeout(() => {
          notification.style.transform = "translateX(100%)";
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 3000);
      }
    </script>
  </body>
</html>
